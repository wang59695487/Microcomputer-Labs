/*---------------------18B20.h--------------------*/
#include<reg52.h>
#define uchar unsigned char
#define uint unsigned int
typedef unsigned char uint8;
sbit DQ = P3^7;                // ??DQ???P3.7
uchar code Bw[10]={0x30,0x31,0x32,0x33,0x34,0x35,
0x36,0x37,0x38,0x39};		//????
uchar code  Xsw[16]={0x30,0x31,0x31,0x32,0x33,0x33,
0x34,0x34,0x35,0x36,0x36,0x37,0x38,0x38,0x39,0x39};//?????
sbit BUSY = P0^7;
uchar wendu,temp_g,temp_d;
//????

void Delayus(int t) /*?11.059MHz?????????????24탎 ,???????16탎*/
{ int s;
 for (s=0; s<t;s++);}  
void wait(void)
{	P0 = 0xFF;
		do	{	RS = 0;
		RW = 1;
		EN = 0;
		EN = 1;
}
while (BUSY == 1);
	EN = 0;}
void w_dat(uint8 dat)
{	wait();
	EN = 0;
	P0 = dat;
	RS = 1;
	RW = 0;
	EN = 1;
	EN = 0;}
void w_cmd(uint8 cmd)
{	wait();	
	EN = 0;
	P0 = cmd;	
	RS = 0;
	RW = 0;	
	EN = 1;	
	EN = 0;}
void w_string(uint8 addr_start, uint8 *p)
{	w_cmd(addr_start);
	while (*p != '\0')
	{		w_dat(*p++);	
	}
}
void Init_LCD1602(void)
{	w_cmd(0x38);  // 16*2??,5*7??,8?????
	w_cmd(0x0c);  // ???????????????
	w_cmd(0x06);  // ????,??????
	w_cmd(0x01);  // ??
}
uchar Reset()//???????????
{
	 uchar d;
	 DQ = 0;  		// ? DQ ???
	 Delayus(29); 	/*?? 480탎 .?????480탎,???????(480-24)/16 = 28.5,?29탎?*/
	 DQ = 1; 		// DQ?????
	 Delayus(3); 	/* ??????.??70탎????????,???????(70-24)/16 = 2.875,?3탎?*/
	 d = DQ; 		// ??????
	 Delayus(25); 	// ???????
	 return(d); 	// ??????,0 = ????, 1 = ???
}
void write_bit(uchar bitval)//??????1??:bitval
{ 
	 DQ = 0; 	// ?DQ ????????
	 if(bitval==1)
	 DQ =1; 	// ???1,DQ ?????
	 Delayus(2);// ??????????,
	 DQ = 1; 	// Delayus????????16탎,??Delayus(5)=5*16+24=104탎
}	
void ds18write_byte(char val)//???????????:val 
{ uchar i;
 uchar temp;
 for (i=0; i<8; i++)		// ????, ?????? 
 {
  temp = val>>i; 		
  temp &= 0x01; 		
  write_bit(temp);  }
  Delayus(5);
  }
uchar read_bit()/*???????????,???????15탎,?????????? */
{					//?Delayus()??,?????for()????????
 uchar i;
 DQ = 0;     		 //?DQ ????????
 DQ = 1; 			// ???????
 for (i=0; i<3; i++); 	// ??15탎
 return(DQ); 			// ?? DQ ??????
}
uchar ds18read_byte()	//???????????? 
{uchar i;
 uchar value = 0;
 for (i=0;i<8;i++) 
 {  				// ????,????????
  if(read_bit()) 
   value|=0x01<<i; 	// ??????
 Delayus(1); 			
  }
 return(value);}
int Readtemperature()/*???????????????????????????????????,????????,???Match ROM??????????*/
{					
uchar temp_d,temp_g,k,get[2],temp; Reset();
 	ds18write_byte(0xcc); 					// ?? ROM
 	ds18write_byte(0x44); 					// ??????
 	Delayus(2);
   Reset();
 	ds18write_byte(0xcc); 					// ?? ROM
 	ds18write_byte(0xbe); 					// ????
 for (k=0;k<2;k++)
 	{  get[k]=ds18read_byte(); }
 temp_d = get[0];			//??
 temp_g = get[1];			//??
if((temp_g&0xf0)==0xf0) //?????
  {    temp_d=~temp_d;
	if(temp_d==0xff) //??-48(1111110100000000)?-32?-16????
	  { temp_d=temp_d+0x01;		//00000000
  	   temp_g=~temp_g;			//00000010
	   temp_g=temp_g+0x01; }		//00000011	 
	else
	  {	   
temp_d=temp_d+0x01; 	
  		 temp_g=~temp_g;       
 	  }		 
	w_cmd(0xc5);
    temp=((temp_d&0xf0)>>4)|((temp_g&0x0f)<<4);
w_cmd(0xc1);			  
}
 else  //??
  {   w_cmd(0xc5);
  	  temp=((temp_d&0xf0)>>4)|((temp_g&0x0f)<<4);
     w_cmd(0xc1);		 
 }	 
 return temp;
}